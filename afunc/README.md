# afunc 概述

`afunc` (Agent Function) 是一个基于模板和原子化函数（AFunc）的任务执行框架。它旨在通过标准化的任务描述、模板和可复用的 AFunc，实现 AI 代理在软件开发任务（尤其是 C/C++ 项目）中的高效协作和自动化。

## 核心概念

1.  **AFunc (Agent Function)**:
    *   **定义**: 原子化的、可复用的功能单元，每个 AFunc 完成一个特定的、定义良好的任务（例如：读取 Makefile、生成 CMakeLists.txt、运行 CMake 目标）。
    *   **描述**: 每个 AFunc 都有一个 YAML 文件（位于 `afunc/afuncs/` 目录），定义了其 `name`（唯一标识）、`description`（功能描述）、`tools`（允许使用的工具列表）、`capability`（详细能力说明）、`inputs`（输入参数）、`outputs`（输出结果）和 `instructions`（执行步骤）。

2.  **任务 (Task)**:
    *   **定义**: 一个更高级别的目标，其核心依赖于一个或多个原子 AFunc 的有序执行来完成。任务本身也可以是一个模板。
    *   **描述**: 任务文档（位于 `afunc/tasks/` 目录，通常是 Markdown 文件）描述了任务的总体目标、TODO 列表（**明确列出需要调用的 AFunc 序列**）、Runtime Context（AFunc 间数据传递）、任务交付件以及测试/审查报告。

3.  **模板 (Template)**:
    *   **定义**: 用于生成特定类型文档或结构的标准化格式。
    *   **描述**: 模板文件（位于 `afunc/templates/` 目录）提供了创建新 AFunc、任务、PRD、架构文档等的结构和初始内容。

4.  **Runtime Context**:
    *   **定义**: 一个动态数据区，用于在任务执行过程中，在不同的 AFunc 之间传递数据和状态。
    *   **作用**: 允许一个 AFunc 的输出成为另一个 AFunc 的输入，实现任务的流水线式执行。

## 核心机制

*   **任务驱动与 AFunc 协调**: **任务的核心执行逻辑完全依赖于对原子 AFunc 的精确调度和协调。** 任务文档通过其 TODO 列表，定义了 AFunc 的调用顺序和依赖关系。例如，任务 A 可能需要先调用 AFunc X，然后使用 X 的输出作为输入调用 AFunc Y。这种机制将复杂任务分解为可管理、可验证的原子步骤。
*   **数据流与 Runtime Context**: 任务执行的核心是数据在 AFunc 间的有序流动。Runtime Context 作为共享数据区，确保一个 AFunc 的输出能准确无误地成为下一个 AFunc 的输入，形成清晰的处理链路，**从而支撑起任务对 AFunc 序列的依赖**。
*   **模板化与标准化**: 通过统一的模板（如 AFunc YAML 定义、任务 Markdown 结构、各类文档模板）确保了产出物的一致性和规范性，降低了 AI 协作的沟通成本和出错率，**使得 AFunc 的定义和任务的编写更加高效和一致**。
*   **原子化能力复用**: 每个 AFunc 提供单一、明确的功能，可在不同任务中复用。这种设计提高了开发效率，并促进了功能的模块化和可维护性，**为任务提供了丰富且可组合的“积木”**。

## 如何使用

1.  **理解任务**: 查看特定任务的 Markdown 文档（在 `afunc/tasks/` 目录下），**重点关注其 TODO 列表，这会明确展示任务依赖哪些 AFunc 以及它们的执行顺序**。
2.  **执行任务**: 任务文档会指明需要调用哪些 AFunc，以及它们的执行顺序和输入输出如何通过 Runtime Context 传递。AI 代理将按照这个顺序依次执行 AFunc。
3.  **利用 AFunc**: 每个 AFunc 的 YAML 文件详细说明了其功能、所需输入和产生的输出。AI 代理根据这些信息来正确调用 AFunc，并将其输出填充到 Runtime Context 中供后续 AFunc 使用。
4.  **使用模板**: 当需要创建新的 AFunc 或任务时，参考 `afunc/templates/` 目录下的相应模板进行初始化，以确保与现有框架的兼容性。

## 如何新增

1.  **新增 AFunc**:
    *   在 `afunc/afuncs/` 目录下创建一个新的 YAML 文件。
    *   参考 `afunc/templates/func-tmpl.md` 填写 AFunc 的元数据、描述、能力、输入输出和详细指令。
    *   明确该 AFunc 允许使用的 `tools`。新增的 AFunc 可以被现有任务引用，或用于创建新任务。

2.  **新增任务**:
    *   在 `afunc/tasks/` 目录下创建一个新的 Markdown 文件。
    *   参考 `afunc/templates/task-tmpl.md` 定义任务名称、描述、**TODO 列表（这是关键，需明确列出任务将调用的所有 AFunc 及其顺序）**、交付件等。
    *   设计任务的 Runtime Context，明确 AFunc 间的数据传递关系，**以确保任务能够正确依赖和串联起这些 AFunc**。

3.  **新增/更新模板**:
    *   在 `afunc/templates/` 目录下创建新的模板文件或修改现有模板。
    *   确保模板清晰、通用，并能指导用户正确创建新的 AFunc 或任务文档，特别是强调 AFunc 的定义方式和任务对 AFunc 的依赖关系。

## 总结

`afunc` 框架的核心在于**任务对原子 AFunc 的依赖和组合**。通过将复杂任务分解为一系列标准化的 AFunc，并利用 RuntimeContext 进行数据流转，框架实现了 AI 代理在软件开发任务中的高效协作和自动化。模板化机制则确保了整个体系的规范性和可扩展性。
